## --- Test simple metropolis_min and metropolis_minmax functions

    mu, sigma = collect(100:0.1:101), 0.01*ones(11);
    @test Chron.check_dist_ll(MeltsVolcanicZirconDistribution, mu, sigma, 100,101) ≈ -3.6933357793356576

    tmindist, tmaxdist, lldist, acceptancedist = metropolis_minmax(2*10^5, MeltsVolcanicZirconDistribution, mu, sigma, burnin=10^5)
    @test isapprox(nanmean(tmindist), 99.92, atol=0.015)
    @test isapprox(nanmean(tmaxdist), 101.08, atol=0.015)
    @test isapprox(nanmean(metropolis_min(2*10^5, MeltsVolcanicZirconDistribution, mu, sigma, burnin=10^5)), 99.9228, atol=0.015)


## -- Test distribution bootstrapping

     dist = BootstrapCrystDistributionKDE(1:10)
     @test isapprox(dist, [0.465404, 0.503149, 0.540308, 0.576485, 0.611314, 0.644472, 0.675691, 0.704756, 0.731516, 0.75588, 0.777815, 0.797345, 0.81454, 0.82951, 0.842398, 0.85337, 0.862605, 0.87029, 0.876611, 0.881749, 0.885873, 0.889136, 0.891676, 0.893612, 0.895043, 0.896047, 0.896684, 0.896993, 0.896993, 0.896684, 0.896047, 0.895043, 0.893612, 0.891676, 0.889136, 0.885873, 0.881749, 0.876611, 0.87029, 0.862605, 0.85337, 0.842398, 0.82951, 0.81454, 0.797345, 0.777815, 0.75588, 0.731516, 0.704756, 0.675691, 0.644472, 0.611314, 0.576485, 0.540308, 0.503149, 0.465404, 0.427489, 0.389826, 0.352829, 0.316888, 0.282361, 0.249559, 0.218742, 0.19011, 0.163804, 0.139901, 0.118424, 0.099338, 0.082567, 0.067992, 0.055465, 0.044819, 0.03587, 0.028432, 0.022318, 0.017347, 0.01335, 0.010173, 0.007675, 0.005732, 0.004238, 0.003102, 0.002247, 0.001612, 0.001145, 0.000806, 0.000563, 0.000392, 0.000275, 0.000197, 0.00015, 0.000128], atol=0.00001)

     dist = BootstrapCrystDistributionKDE(1:10, ones(10))
     @test isapprox(dist, [0.500228, 0.535143, 0.569056, 0.601647, 0.632641, 0.661805, 0.688961, 0.713982, 0.736794, 0.757375, 0.775748, 0.79198, 0.806169, 0.818443, 0.828947, 0.837842, 0.845291, 0.851459, 0.856502, 0.86057, 0.863796, 0.866299, 0.868179, 0.869517, 0.870375, 0.870794, 0.870794, 0.870375, 0.869517, 0.868179, 0.866299, 0.863796, 0.86057, 0.856502, 0.851459, 0.845291, 0.837842, 0.828947, 0.818443, 0.806169, 0.79198, 0.775748, 0.757375, 0.736794, 0.713982, 0.688961, 0.661805, 0.632641, 0.601647, 0.569056, 0.535143, 0.500228, 0.464656, 0.428798, 0.39303, 0.357728, 0.323251, 0.289935, 0.258079, 0.227938, 0.199721, 0.173583, 0.149624, 0.127894, 0.108393, 0.091075, 0.075858, 0.062627, 0.051244, 0.041553, 0.03339, 0.026585, 0.020972, 0.016391, 0.012691, 0.009734, 0.007396, 0.005566, 0.004149, 0.003064, 0.002241, 0.001623, 0.001166, 0.00083, 0.000587, 0.000415, 0.000295, 0.000215, 0.000166, 0.000143], atol=0.00001)

## -- Test systematic uncertainty propagation

    dist = 100 .+ randn(100000)

    dist_upb = add_systematic_uncert_UPb(dist)
    @test std(dist_upb) > std(dist)
    @test isapprox(std(dist_upb) - std(dist), 0.0015, atol=0.0006)

    dist_ar = add_systematic_uncert_ArAr(dist)
    @test std(dist_ar) > std(dist)
    @test isapprox(std(dist_ar) - std(dist), 0.005, atol=0.002)

    dist2d = 100 .+ randn(1000,1000)

    dist_upb = add_systematic_uncert_UPb(dist2d)
    # Check that uncertainty is added in vertical bands
    diff = dist_upb .- dist2d
    @test all(std(diff,dims=2) .> std(diff,dims=1)')

    dist_ar = add_systematic_uncert_ArAr(dist2d)
    # Check that uncertainty is added in vertical bands
    diff = dist_ar .- dist2d
    @test all(std(diff,dims=2) .> std(diff,dims=1)')

## -- Test decompact function
    y = [0, 0.2, 0.45, 1.2, 2.5, 3.4, 3.6, 4, 4.25, 5, 5.4]
    ϕ₀ = [0.63, 0.49, 0.63, 0.70, 0.49, 0.40, 0.20, 0.49, 0.05, 0.20]
    c = [0.51, 0.27, 0.51, 0.71, 0.27, 0.60, 0.60, 0.27, 0.20, 0.30]
    Y = fill(1E-18, (11, 11))
    Y[:,1] .= y
    Y[1,:] .= 0
    for i = 2:10
        for j = i:10
            SubsidenceChron.decompact!(view(Y,:,i), y, ϕ₀[j], c[j], j, i)
        end
    end
    Y_target = vcat(
        [0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0],
        [0.2  0.261474  0.887641  1.74732  1.20451  0.300026  0.474364  0.392066  0.770834  0.471032  1.0e-18],
        [0.45  1.06158  2.26118  2.70626  1.43681  0.758822  0.830523  1.1601  1.22082  1.0e-18  1.0e-18],
        [1.2  2.39165  3.17795  2.9117  1.86018  1.09798  1.59568  1.60168  1.0e-18  1.0e-18  1.0e-18],
        [2.5  3.29906  3.37943  3.31601  2.15361  1.86152  2.02924  1.0e-18  1.0e-18  1.0e-18  1.0e-18],
        [3.4  3.4997  3.78061  3.57605  2.91158  2.29078  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18],
        [3.6  3.90022  4.03355  4.32824  3.32741  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18],
        [4.0  4.15153  4.78422  4.73219  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18],
        [4.25  4.90183  5.1854  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18],
        [5.0  5.30235  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18],
        [5.4  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18  1.0e-18]
    )
    @test isapprox(Y, Y_target, atol=0.001)

## --- Test DecompactBackstrip function
    strat_test = NewStratData(3)
    strat_test.Lithology = ["Shale", "Sandstone", "Limestone"]
    strat_test.Thickness .= [1, 0.6, 0.4]
    nsims_test = 5000
    res_test = 0.02
    (Sₜ_test, Sμ_test, Sσ_test, model_strat_heights_test) = SubsidenceChron.DecompactBackstrip(strat_test, nsims_test, res_test)
    
    model_strat_heights_target = 0:0.02:2
    @test isapprox(model_strat_heights_test, model_strat_heights_target, atol=0.0001)
    
    Sμ_target = [1098.927, 1093.926, 1088.810, 1083.576, 1078.223, 1072.751, 1067.158, 1061.443, 1055.603, 1049.638, 1043.546, 1037.324, 1030.971, 1024.484, 1017.862, 1011.102, 1004.200, 997.155, 989.963, 982.621, 975.125, 967.473, 959.658, 951.678, 943.528, 935.202, 926.695, 918.001, 909.114, 900.027, 890.731, 881.218, 871.480, 861.506, 851.284, 840.802, 830.046, 819.000, 807.646, 795.964, 783.930, 771.517, 758.693, 745.420, 731.652, 717.332, 702.390, 686.730, 670.225, 652.686, 633.802, 623.305, 612.731, 602.079, 591.350, 580.543, 569.657, 558.691, 547.646, 536.520, 525.313, 514.025, 502.655, 491.203, 479.668, 468.051, 456.349, 444.564, 432.694, 420.740, 408.701, 396.576, 384.367, 372.071, 359.689, 347.222, 334.667, 322.026, 309.298, 296.481, 283.577, 271.977, 260.189, 248.205, 236.016, 223.613, 210.984, 198.119, 185.005, 171.627, 157.970, 144.015, 129.744, 115.131, 100.150, 84.768, 68.948, 52.638, 35.778, 18.277, 0.000]
    for i = 1:length(Sμ_target)
        final_bool = true
        if isapprox(Sμ_test[i], Sμ_target[i], atol=3) == false
            final_bool = false
        end
        return @test final_bool
    end

## --- Test subsidence_ll function

## --- Test SubsidenceStratMetropolis function



